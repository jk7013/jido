<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Prompt A/B 결과 비교</title>

    <!-- ✅ jido 공통 테마 -->
    <link rel="stylesheet" href="css/jido-theme.css" />

    <!-- Markdown & Highlight.js -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/highlight.js@11.8.0/styles/github-dark.min.css"
    />
    <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.8.0/lib/highlight.min.js"></script>

    <style>
      /* ✅ 화면 전체 높이 채우기 */
      html,
      body {
        height: 100%;
      }

      body.result-view {
        display: flex;
        flex-direction: column;
        min-height: 100vh;
      }

      main.wrap {
        flex: 1;
        padding: 16px;
        display: flex;
        flex-direction: column;
        width: 100%;
      }

      section.panel {
        background: var(--panel);
        border: 1px solid var(--muted);
        border-radius: 10px;
        box-shadow: 0 1px 0 #0002;
        display: flex;
        flex-direction: column;
        flex: 1;
        min-height: calc(100vh - 120px);
        width: 100%;
        max-width: none;
      }

      section.panel .content {
        flex: 1;
        overflow-y: auto;
        padding: 14px;
      }

      section.panel header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 14px;
        border-bottom: 1px solid var(--muted);
      }

      /* 헤더 컨트롤 요소들이 한 줄로 표시되도록 */
      body.result-view header .right {
        display: flex;
        align-items: center;
        gap: 8px;
        flex-wrap: nowrap;
        min-width: 0;
      }

      body.result-view header .right select {
        min-width: 200px;
        max-width: 300px;
      }

      body.result-view header .right input[type="range"] {
        min-width: 80px;
        max-width: 120px;
      }

      /* single_result_view.html과 완전히 동일한 헤더 스타일 */
      body.result-view header {
        padding: 18px 22px;
        border-bottom: 1px solid var(--muted);
        display: flex;
        gap: 12px;
        align-items: center;
        justify-content: space-between;
        background: var(--panel);
      }

      body.result-view header h1 {
        font-size: 18px;
        font-weight: 600;
        margin: 0;
        color: var(--text);
      }

      /* single_result_view.html과 완전히 동일한 헤더 컨트롤 스타일 */
      body.result-view header .right {
        display: flex;
        align-items: center;
        gap: 8px;
        flex-wrap: nowrap;
        min-width: 0;
      }

      body.result-view header .right select {
        background: #111623;
        color: var(--text);
        border: 1px solid #2a3042;
        border-radius: 8px;
        padding: 7px 10px;
        font-size: 13px;
        min-width: 200px;
        max-width: 300px;
      }

      body.result-view header .right input[type="range"] {
        min-width: 80px;
        max-width: 120px;
        accent-color: var(--accent);
      }

      body.result-view header .right button {
        background: linear-gradient(180deg, #1a1f2b 0%, #0d111a 100%);
        border: 1px solid #27324a;
        color: #eaf6ff;
        font-weight: 600;
        padding: 7px 12px;
        border-radius: 6px;
        font-size: 13px;
        white-space: nowrap;
        cursor: pointer;
        transition: all 0.25s ease;
        box-shadow: 0 0 6px rgba(0, 0, 0, 0.4);
      }

      body.result-view header .right button.ghost {
        background: transparent;
        color: var(--accent);
        border: 1px solid #2f3a55;
        font-weight: 500;
        padding: 6px 11px;
      }

      body.result-view header .right label {
        color: var(--sub);
        font-size: 12px;
        white-space: nowrap;
        margin: 0;
      }

      /* 상태 점 스타일 */
      .status-dot {
        display: inline-block;
        width: 10px;
        height: 10px;
        border-radius: 50%;
        margin-right: 8px;
      }

      .status-dot.good {
        background: var(--good);
      }

      .status-dot.bad {
        background: var(--bad);
      }

      body.result-view .panel header {
        padding: 12px 14px;
      }

      body.result-view .panel h2 {
        font-size: 14px;
        font-weight: 600;
        color: var(--text);
      }

      article.md.big {
        line-height: 1.6;
        white-space: pre-wrap;
        word-break: break-word;
      }
    </style>
  </head>

  <body class="result-view">
    <div id="header-placeholder"></div>

    <script>
      fetch("components/header.html")
        .then((res) => res.text())
        .then((html) => {
          document.getElementById("header-placeholder").innerHTML = html;
        });
    </script>

    <header>
      <h1>Prompt A/B 결과 비교</h1>
      <div class="right">
        <label style="color: var(--sub); font-size: 12px">실행 선택:</label>
        <select id="runSelect"></select>
        <button class="ghost" id="btnPrev">이전</button>
        <button class="ghost" id="btnNext">다음</button>
        <label style="color: var(--sub); font-size: 12px; margin-left: 8px">
          글자 크기
        </label>
        <input type="range" id="fontRange" min="14" max="22" value="16" />
        <button class="ghost" onclick="location.href='dashboard.html'">
          ← 대시보드
        </button>
        <button onclick="window.print()">인쇄/전체 저장</button>
      </div>
    </header>

    <main class="wrap">
      <!-- A/B 비교 결과 -->
      <section class="panel">
        <header>
          <div class="sideTitle">
            <span class="status-dot good"></span>
            <strong id="titleA">Prompt A</strong>
          </div>
          <div class="meta">
            <span class="pill" id="metaA1">Latency: -</span>
            <span class="pill" id="metaA2">Tokens: -</span>
            <span class="pill" id="metaA3">Faith/Rel/CtxP/CtxR: -</span>
          </div>
        </header>
        <div class="content">
          <article class="md big" id="mdA">A 결과 없음</article>
        </div>
      </section>

      <section class="panel">
        <header>
          <div class="sideTitle">
            <span class="status-dot bad"></span>
            <strong id="titleB">Prompt B</strong>
          </div>
          <div class="meta">
            <span class="pill" id="metaB1">Latency: -</span>
            <span class="pill" id="metaB2">Tokens: -</span>
            <span class="pill" id="metaB3">Faith/Rel/CtxP/CtxR: -</span>
          </div>
        </header>
        <div class="content">
          <article class="md big" id="mdB">B 결과 없음</article>
        </div>
      </section>
    </main>

    <footer>
      Markdown 기반 LLM 출력 비교 — 하이라이트 및 구조화된 분석 결과를 표시
    </footer>

    <script>
      const runs = JSON.parse(localStorage.getItem("ab_runs") || "[]");
      const runSelect = document.getElementById("runSelect");
      const titleA = document.getElementById("titleA");
      const titleB = document.getElementById("titleB");
      const mdA = document.getElementById("mdA");
      const mdB = document.getElementById("mdB");
      const metaA1 = document.getElementById("metaA1");
      const metaA2 = document.getElementById("metaA2");
      const metaA3 = document.getElementById("metaA3");
      const metaB1 = document.getElementById("metaB1");
      const metaB2 = document.getElementById("metaB2");
      const metaB3 = document.getElementById("metaB3");

      if (!runs.length) {
        mdA.textContent =
          "localStorage에 실행 결과(ab_runs)가 없습니다. 대시보드에서 먼저 테스트를 실행하세요.";
        mdB.textContent = "—";
      }

      function fillSelect() {
        runSelect.innerHTML = "";
        runs.forEach((r, idx) => {
          const o = document.createElement("option");
          const ts = new Date(r.time || Date.now()).toLocaleString();
          o.value = idx;
          o.textContent = `#${idx + 1} · ${ts} · ${
            r.promptA?.name || "A"
          } vs ${r.promptB?.name || "B"} · "${(r.query || "").slice(0, 28)}"`;
          runSelect.appendChild(o);
        });
        if (runs.length) runSelect.value = runs.length - 1;
      }
      fillSelect();

      marked.setOptions({
        breaks: true,
        highlight: function (code, lang) {
          try {
            return hljs.highlight(code, { language: lang }).value;
          } catch (e) {
            return hljs.highlightAuto(code).value;
          }
        },
      });

      function fmt(n) {
        return typeof n === "number" ? n.toFixed(2) : n;
      }

      function render(idx) {
        if (!runs.length) return;
        const r = runs[idx];
        titleA.textContent = r.promptA?.name || "Prompt A";
        titleB.textContent = r.promptB?.name || "Prompt B";
        metaA1.textContent = `Latency: ${r.latA} ms`;
        metaA2.textContent = `Tokens: ${r.tokA}`;
        metaA3.textContent = `Faith/Rel/CtxP/CtxR: ${fmt(
          r.scores?.A?.faithfulness
        )}/${fmt(r.scores?.A?.relevancy)}/${fmt(r.scores?.A?.ctxPrecision)}/${fmt(
          r.scores?.A?.ctxRecall
        )}`;
        metaB1.textContent = `Latency: ${r.latB} ms`;
        metaB2.textContent = `Tokens: ${r.tokB}`;
        metaB3.textContent = `Faith/Rel/CtxP/CtxR: ${fmt(
          r.scores?.B?.faithfulness
        )}/${fmt(r.scores?.B?.relevancy)}/${fmt(r.scores?.B?.ctxPrecision)}/${fmt(
          r.scores?.B?.ctxRecall
        )}`;

        mdA.innerHTML = marked.parse(r.ansA || "_(A 응답 없음)_");
        mdB.innerHTML = marked.parse(r.ansB || "_(B 응답 없음)_");
      }
      if (runs.length) render(runs.length - 1);

      runSelect.addEventListener("change", (e) => render(+e.target.value));
      document.getElementById("btnPrev").addEventListener("click", () => {
        if (!runs.length) return;
        const i = Math.max(0, +runSelect.value - 1);
        runSelect.value = i;
        render(i);
      });
      document.getElementById("btnNext").addEventListener("click", () => {
        if (!runs.length) return;
        const i = Math.min(runs.length - 1, +runSelect.value + 1);
        runSelect.value = i;
        render(i);
      });
      document
        .getElementById("fontRange")
        .addEventListener("input", (e) => {
          const size = e.target.value + "px";
          document
            .querySelectorAll(".big")
            .forEach((el) => (el.style.fontSize = size));
        });
    </script>
  </body>
</html>
