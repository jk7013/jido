<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Prompt 결과 보기 (단일 프롬프트)</title>

    <!-- ✅ jido 공통 테마 -->
    <link rel="stylesheet" href="css/jido-theme.css" />

    <!-- Markdown & Highlight.js -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/highlight.js@11.8.0/styles/github-dark.min.css"
    />
    <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.8.0/lib/highlight.min.js"></script>
    <style>
      /* ✅ 화면 전체 높이 채우기 */
      html,
      body {
        height: 100%;
      }

      body.single-result-view {
        display: flex;
        flex-direction: column;
        min-height: 100vh;
      }

      main.wrap {
        flex: 1;
        padding: 16px;
        display: flex;
        flex-direction: column;
        width: 100%;
      }

      section.panel {
        background: var(--panel);
        border: 1px solid var(--muted);
        border-radius: 10px;
        box-shadow: 0 1px 0 #0002;
        display: flex;
        flex-direction: column;
        flex: 1;
        min-height: calc(100vh - 120px);
        width: 100%;
        max-width: none;
      }

      section.panel header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 14px;
        border-bottom: 1px solid var(--muted);
      }

      section.panel .content {
        flex: 1;
        overflow-y: auto;
        padding: 14px;
      }

      /* 헤더 컨트롤 요소들이 한 줄로 표시되도록 */
      body.single-result-view header .right {
        display: flex;
        align-items: center;
        gap: 8px;
        flex-wrap: nowrap;
        min-width: 0;
      }

      body.single-result-view header .right select {
        min-width: 200px;
        max-width: 300px;
      }

      body.single-result-view header .right input[type="range"] {
        min-width: 80px;
        max-width: 120px;
      }

      /* result_view.html과 완전히 동일한 헤더 스타일 */
      body.single-result-view header {
        padding: 18px 22px;
        border-bottom: 1px solid var(--muted);
        display: flex;
        gap: 12px;
        align-items: center;
        justify-content: space-between;
        background: var(--panel);
      }

      body.single-result-view header h1 {
        font-size: 18px;
        font-weight: 600;
        margin: 0;
        color: var(--text);
      }

      /* result_view.html과 완전히 동일한 헤더 컨트롤 스타일 */
      body.single-result-view header .right {
        display: flex;
        align-items: center;
        gap: 8px;
        flex-wrap: nowrap;
        min-width: 0;
        white-space: nowrap;
      }

      body.single-result-view header .right select {
        background: #111623;
        color: var(--text);
        border: 1px solid #2a3042;
        border-radius: 8px;
        padding: 7px 10px;
        font-size: 13px;
        min-width: 200px;
        max-width: 300px;
      }

      body.single-result-view header .right input[type="range"] {
        min-width: 80px;
        max-width: 120px;
        accent-color: var(--accent);
      }

      body.single-result-view header .right button {
        background: linear-gradient(180deg, #1a1f2b 0%, #0d111a 100%);
        border: 1px solid #27324a;
        color: #eaf6ff;
        font-weight: 600;
        padding: 7px 12px;
        border-radius: 6px;
        font-size: 13px;
        white-space: nowrap;
        cursor: pointer;
        transition: all 0.25s ease;
        box-shadow: 0 0 6px rgba(0, 0, 0, 0.4);
      }

      body.single-result-view header .right button.ghost {
        background: transparent;
        color: var(--accent);
        border: 1px solid #2f3a55;
        font-weight: 500;
        padding: 6px 11px;
      }

      body.single-result-view header .right label {
        color: var(--sub);
        font-size: 12px;
        white-space: nowrap;
        margin: 0;
      }

      article.md.big {
        line-height: 1.6;
        white-space: pre-wrap;
        word-break: break-word;
      }
    </style>
</head>
  <body class="single-result-view">
    <header>
      <h1>Prompt 결과 보기</h1>
      <div class="right">
        <label style="color: var(--sub); font-size: 12px">실행 선택:</label>
        <select id="runSelect"></select>
        <button class="ghost" id="btnPrev">이전</button>
        <button class="ghost" id="btnNext">다음</button>
        <label style="color: var(--sub); font-size: 12px; margin-left: 8px">
          글자 크기
        </label>
        <input type="range" id="fontRange" min="14" max="22" value="16" />
        <button class="ghost" onclick="location.href='dashboard.html'">
          ← 대시보드
        </button>
        <button onclick="window.print()">인쇄/전체 저장</button>
      </div>
    </header>

    <main class="wrap">
      <section class="panel">
        <header>
          <div class="sideTitle">
            <span
              style="
                display: inline-block;
                width: 10px;
                height: 10px;
                border-radius: 50%;
                background: var(--good);
              "
            ></span>
            <strong id="titleA">Prompt</strong>
          </div>
          <div class="meta">
            <span class="pill" id="meta1">Latency: -</span>
            <span class="pill" id="meta2">Tokens: -</span>
            <span class="pill" id="meta3">Faith/Rel/CtxP/CtxR: -</span>
          </div>
        </header>
        <div class="content">
          <article class="md big" id="md">결과 없음</article>
        </div>
      </section>
    </main>

    <footer>
      Markdown 기반 LLM 출력 비교 — 하이라이트 및 구조화된 분석 결과를 표시
    </footer>

    <script>
const runs = JSON.parse(localStorage.getItem("single_runs") || "[]");
const runSelect = document.getElementById('runSelect');
const titleA = document.getElementById('titleA');
const meta1 = document.getElementById('meta1');
const meta2 = document.getElementById('meta2');
const meta3 = document.getElementById('meta3');
const md = document.getElementById('md');

if(!runs.length){
  md.textContent = "localStorage에 실행 결과(single_runs)가 없습니다. 대시보드에서 먼저 테스트를 실행하세요.";
}

function fillSelect(){
  runSelect.innerHTML = "";
  runs.forEach((r, idx)=>{
    const o = document.createElement('option');
    const ts = new Date(r.time || Date.now()).toLocaleString();
    o.value = idx;
    o.textContent = `#${idx+1} · ${ts} · ${(r.prompt?.name || 'Prompt')} · "${(r.query||'').slice(0,28)}"`;
    runSelect.appendChild(o);
  });
  if(runs.length) runSelect.value = runs.length-1;
}
fillSelect();

marked.setOptions({
  breaks: true,
  highlight: function(code, lang) {
    try { return hljs.highlight(code, {language: lang}).value; }
    catch(e){ return hljs.highlightAuto(code).value; }
  }
});

function fmt(n){ return (typeof n === 'number') ? n.toFixed(2) : n; }

function render(idx){
  if(!runs.length) return;
  const r = runs[idx];
  titleA.textContent = r.prompt?.name || 'Prompt';
  meta1.textContent = `Latency: ${r.lat} ms`;
  meta2.textContent = `Tokens: ${r.tok}`;
  meta3.textContent = `Faith/Rel/CtxP/CtxR: ${fmt(r.scores?.faithfulness)}/${fmt(r.scores?.relevancy)}/${fmt(r.scores?.ctxPrecision)}/${fmt(r.scores?.ctxRecall)}`;
  md.innerHTML = marked.parse(r.answer || "_(응답 없음)_");
}
if(runs.length) render(runs.length-1);

runSelect.addEventListener('change', e => render(+e.target.value));
document.getElementById('btnPrev').addEventListener('click', ()=>{
  if(!runs.length) return;
  const i = Math.max(0, (+runSelect.value)-1);
  runSelect.value = i; render(i);
});
document.getElementById('btnNext').addEventListener('click', ()=>{
  if(!runs.length) return;
  const i = Math.min(runs.length-1, (+runSelect.value)+1);
  runSelect.value = i; render(i);
});
document.getElementById('fontRange').addEventListener('input', e=>{
  const size = e.target.value + 'px';
  document.querySelectorAll('.big').forEach(el => el.style.fontSize = size);
});
</script>
</body>
</html>
