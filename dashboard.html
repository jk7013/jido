<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Prompt A/B 테스트 대시보드</title>
  <link rel="stylesheet" href="css/jido-theme.css" />
</head>

  <body>
    <header>
      <h1>Prompt A/B 테스트 대시보드</h1>
      <div class="right">
        <button class="ghost" id="btnExport">CSV로 내보내기</button>
        <button class="ghost" id="btnResultView">결과 보기</button>
        <span class="muted" id="runCount">runs: 0</span>
        <nav class="top-menu">
          <button class="ghost" onclick="location.href='dashboard.html'">
            대시보드
          </button>
          <button class="ghost" onclick="location.href='result_view.html'">
            결과 보기
          </button>
          <button class="ghost" onclick="location.href='log_view_css.html'">
            로그 보기
          </button>
          <button
            class="ghost"
            onclick="window.open('https://gitlab.company.local/promptops', '_blank')"
            style="display: flex; align-items: center; gap: 4px; background: #ff6b35; color: white; border: 1px solid #ff6b35;"
          >
            <img
              src="img/gitlab.svg"
              alt="GitLab"
              style="width:16px; height:16px; filter: brightness(0) invert(1);"
            />
            GitLab
          </button>
        </nav>
      </div>
    </header>


    <div class="wrap">
      <!-- 좌: 컨트롤 -->
      <section class="panel">
        <h2>실행 컨트롤</h2>
        <div class="content">
          <!-- 토글 스위치 -->
          <div class="toggle-container">
            <span class="toggle-label">Single Mode</span>
            <div class="toggle-switch" id="modeToggle">
              <div class="toggle-slider"></div>
            </div>
            <span class="toggle-label">A/B Mode</span>
          </div>
          
          <div class="prompt-row">
            <div class="prompt-a-container">
              <label>프롬프트 A (버전/설명)</label>
              <input
                type="text"
                id="promptA_name"
                placeholder="예: legal_rag_v0.3.4 (strict)"
              />
              <label>프롬프트 A 템플릿</label>
              <textarea
                id="promptA_tpl"
                placeholder="예: 시스템 지침 + 요약/근거 제시 요구..."
              ></textarea>
            </div>
            <div class="prompt-b-container">
              <label>프롬프트 B (버전/설명)</label>
              <input
                type="text"
                id="promptB_name"
                placeholder="예: legal_rag_v0.3.5 (concise)"
              />
              <label>프롬프트 B 템플릿</label>
              <textarea
                id="promptB_tpl"
                placeholder="예: 톤/형식 변경 템플릿..."
              ></textarea>
            </div>
          </div>

          <div class="row" style="margin-top: 10px">
            <div>
              <label>사용자 질문</label>
              <input
                type="text"
                id="userQuery"
                placeholder='예: "회사차를 타고 가면 사규에 어긋나?"'
              />
              <div class="hint">
                여러 건 테스트하려면 테스트셋 모드(하단 표 우측 상단 버튼)로
                확장 가능
              </div>
            </div>
            <div>
              <label>평가 옵션</label>
              <select id="judgeMode">
                <option value="auto">Auto Judge (LLM 기반)</option>
                <option value="heuristic">Heuristic (유사도/길이/포맷)</option>
              </select>
              <label style="margin-top: 8px">모델/엔드포인트 (표기용)</label>
              <input
                type="text"
                id="modelName"
                placeholder="예: internal-llm-rag@v2"
              />
            </div>
          </div>

          <div class="exec-controls">
            <button id="btnRun">A/B 실행</button>
            <button class="ghost" id="btnClear">화면 초기화</button>
          </div>
        </div>
      </section>

      <!-- 우: 최근 실행 비교 카드 -->
      <section class="panel">
        <h2 id="resultTitle">최근 실행 비교</h2>
        <div class="content">
          <div class="cards" id="cards">
            <div class="card" id="cardA">
              <div>
                <strong id="labA">Prompt A</strong
                ><span class="badge" id="verA">-</span>
              </div>
              <div class="kv">
                <div>Latency</div>
                <div class="metric" id="latA">-</div>
                <div>Tokens</div>
                <div class="metric" id="tokA">-</div>
                <div>Answer</div>
                <div><pre id="ansA">-</pre></div>
              </div>
            </div>
            <div class="card card-b" id="cardB">
              <div>
                <strong id="labB">Prompt B</strong
                ><span class="badge" id="verB">-</span>
              </div>
              <div class="kv">
                <div>Latency</div>
                <div class="metric" id="latB">-</div>
                <div>Tokens</div>
                <div class="metric" id="tokB">-</div>
                <div>Answer</div>
                <div><pre id="ansB">-</pre></div>
              </div>
            </div>
          </div>

          <div class="similarity-section" style="margin-top: 10px">
            <label>텍스트 유사도 (A vs B)</label>
            <div class="bar"><span id="simBar" style="width: 0%"></span></div>
            <div class="metric" id="simScore">-</div>
          </div>

          <div style="margin-top: 10px">
            <table id="metricTable" class="metric-table">
              <thead>
                <tr>
                  <th>지표</th>
                  <th>A</th>
                  <th>B</th>
                  <th>우세</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td>Faithfulness</td>
                  <td class="metric" id="faA">-</td>
                  <td class="metric" id="faB">-</td>
                  <td id="faW">-</td>
                </tr>
                <tr>
                  <td>Answer Relevancy</td>
                  <td class="metric" id="arA">-</td>
                  <td class="metric" id="arB">-</td>
                  <td id="arW">-</td>
                </tr>
                <tr>
                  <td>Context Precision</td>
                  <td class="metric" id="cpA">-</td>
                  <td class="metric" id="cpB">-</td>
                  <td id="cpW">-</td>
                </tr>
                <tr>
                  <td>Context Recall</td>
                  <td class="metric" id="crA">-</td>
                  <td class="metric" id="crB">-</td>
                  <td id="crW">-</td>
                </tr>
                <tr>
                  <td>Latency (ms)</td>
                  <td class="metric" id="laA">-</td>
                  <td class="metric" id="laB">-</td>
                  <td id="laW">-</td>
                </tr>
                <tr>
                  <td>Tokens</td>
                  <td class="metric" id="toA">-</td>
                  <td class="metric" id="toB">-</td>
                  <td id="toW">-</td>
                </tr>
                <tr>
                  <td>Judge Verdict</td>
                  <td id="jA">-</td>
                  <td id="jB">-</td>
                  <td id="jW">-</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- 전체 실행 로그/집계 -->
      <section class="panel" style="grid-column: 1 / -1">
        <h2>실행 로그 & 집계</h2>
        <div class="content">
          <table id="runTable" class="log-table">
            <thead>
              <tr>
                <th>#</th>
                <th>Query</th>
                <th>Prompt A</th>
                <th class="b-column">Prompt B</th>
                <th>Faith.</th>
                <th>Rel.</th>
                <th>CtxP</th>
                <th>CtxR</th>
                <th class="b-column">Sim</th>
                <th class="b-column">Winner</th>
                <th>LatencyA</th>
                <th class="b-column">LatencyB</th>
                <th>TokensA</th>
                <th class="b-column">TokensB</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>

          <div style="margin-top: 12px" id="summary"></div>
        </div>
      </section>
    </div>

    <footer>
      A/B 테스트 화면 예시 — 프롬프트 버전은 GitLab, 실행/지표 저장은 MLflow
      연동 추천 · CSV 내보내기는 우측 상단 버튼
    </footer>

    <script>
      /** ******************************
       * 데모/스켈레톤 JS
       * - TODO 부분에 백엔드 연동(LLM 호출, RAGAS 점수 계산) 붙이면 실전에서 바로 사용 가능
       *********************************/

      // 상태
      const state = {
        runs: [], // 각 실행의 기록
        isSingleMode: false, // 모드 상태
      };

      // 유틸
      const $ = (q) => document.querySelector(q);
      const fmt = (v) => (v === null || v === undefined ? "-" : v);
      const winPill = (w) =>
        w === "A"
          ? '<span class="pill ok">A</span>'
          : w === "B"
          ? '<span class="pill bad">B</span>'
          : '<span class="pill meh">=</span>';

      // 모드 토글 기능
      function toggleMode() {
        state.isSingleMode = !state.isSingleMode;
        const body = document.body;
        const toggle = $("#modeToggle");
        const resultTitle = $("#resultTitle");
        const runButton = $("#btnRun");
        
        console.log("토글 모드 변경:", state.isSingleMode ? "Single" : "A/B");
        
        if (state.isSingleMode) {
          body.classList.add("single-mode");
          toggle.classList.remove("active");
          resultTitle.textContent = "최근 실행 결과";
          runButton.textContent = "실행";
        } else {
          body.classList.remove("single-mode");
          toggle.classList.add("active");
          resultTitle.textContent = "최근 실행 비교";
          runButton.textContent = "A/B 실행";
        }
      }

      // 초기화 함수
      function initializeApp() {
        // 토글 이벤트 리스너
        const toggleButton = $("#modeToggle");
        if (toggleButton) {
          toggleButton.addEventListener("click", toggleMode);
          console.log("토글 버튼 이벤트 리스너 등록됨");
        }
        
        // 초기 모드 설정 (A/B 모드로 시작)
        state.isSingleMode = false;
        document.body.classList.remove("single-mode");
        $("#modeToggle").classList.add("active");
      }

      // 데모용 랜덤(실전에서는 제거)
      function rand(min, max) {
        return Math.round(min + Math.random() * (max - min));
      }
      function randScore() {
        return Math.round((0.6 + Math.random() * 0.4) * 100) / 100;
      } // 0.6~1.0

      // TODO: 여기에 실제 LLM/RAG 호출을 붙인다.
      async function callLLM(endpointName, promptTemplate, userQuery) {
        // 예시: 실제로는 fetch("/api/run", {method:"POST", body: JSON.stringify({...})})
        const start = performance.now();
        // 응답 본문은 데모 텍스트
        const text = `[${endpointName}] "${userQuery}"에 대한 응답 예시. 템플릿 일부: ${promptTemplate.slice(
          0,
          40
        )}...`;
        const latency = Math.round(performance.now() - start) + rand(150, 800);
        const tokens = rand(120, 480);
        return { text, latency, tokens };
      }

      // TODO: RAGAS 메트릭 계산을 붙인다(백엔드에서 계산 후 점수만 리턴 권장)
      // 여기선 데모로 점수를 생성
      async function evalRAGAS(answerA, answerB) {
        if (state.isSingleMode) {
          return {
            A: {
              faithfulness: randScore(),
              relevancy: randScore(),
              ctxPrecision: randScore(),
              ctxRecall: randScore(),
            },
          };
        } else {
          return {
            A: {
              faithfulness: randScore(),
              relevancy: randScore(),
              ctxPrecision: randScore(),
              ctxRecall: randScore(),
            },
            B: {
              faithfulness: randScore(),
              relevancy: randScore(),
              ctxPrecision: randScore(),
              ctxRecall: randScore(),
            },
          };
        }
      }

      // 간단 유사도(데모) — 실제로는 백엔드에서 문장 임베딩 코사인 유사도 추천
      function naiveSimilarity(a, b) {
        if (!a || !b) return 0;
        const la = a.length,
          lb = b.length;
        const min = Math.min(la, lb),
          max = Math.max(la, lb);
        return Math.round((min / max) * 100);
      }

      // 판정(데모): RAGAS 4개 지표 + 유사도*가중치 + 레이턴시 역가중치
      function judge(w) {
        if (state.isSingleMode) return "A"; // 싱글 모드에서는 판정 불필요
        
        const sA = w.scores.A;
        const sB = w.scores.B;
        const a =
          sA.faithfulness +
          sA.relevancy +
          sA.ctxPrecision +
          sA.ctxRecall +
          (w.sim / 100) * 0.5 -
          (w.latA / 1000) * 0.1;
        const b =
          sB.faithfulness +
          sB.relevancy +
          sB.ctxPrecision +
          sB.ctxRecall +
          (w.sim / 100) * 0.5 -
          (w.latB / 1000) * 0.1;
        if (Math.abs(a - b) < 0.05) return "=";
        return a > b ? "A" : "B";
      }

      // 화면 업데이트
      function renderLatest(latest) {
        // 카드
        $("#labA").textContent = latest.promptA.name || "Prompt A";
        $("#verA").textContent = latest.promptA.name || "-";
        $("#latA").textContent = latest.latA + " ms";
        $("#tokA").textContent = latest.tokA;
        $("#ansA").textContent = latest.ansA;

        if (!state.isSingleMode) {
          $("#labB").textContent = latest.promptB.name || "Prompt B";
          $("#verB").textContent = latest.promptB.name || "-";
          $("#latB").textContent = latest.latB + " ms";
          $("#tokB").textContent = latest.tokB;
          $("#ansB").textContent = latest.ansB;

          // 유사도 바
          $("#simBar").style.width = latest.sim + "%";
          $("#simScore").textContent = `Text Similarity: ${latest.sim}%`;
        }

        // 메트릭 표
        const S = latest.scores;
        const set = (id, v) =>
          ($(id).textContent = typeof v === "number" ? v.toFixed(2) : v);
        set("#faA", S.A.faithfulness);
        set("#arA", S.A.relevancy);
        set("#cpA", S.A.ctxPrecision);
        set("#crA", S.A.ctxRecall);
        set("#laA", latest.latA);
        set("#toA", latest.tokA);

        if (!state.isSingleMode) {
          set("#faB", S.B.faithfulness);
          set("#arB", S.B.relevancy);
          set("#cpB", S.B.ctxPrecision);
          set("#crB", S.B.ctxRecall);
          set("#laB", latest.latB);
          set("#toB", latest.tokB);

          // 우세 표시
          const winCell = (a, b) => (a === b ? "=" : a > b ? "A" : "B");
          $("#faW").innerHTML = winPill(
            winCell(S.A.faithfulness, S.B.faithfulness)
          );
          $("#arW").innerHTML = winPill(winCell(S.A.relevancy, S.B.relevancy));
          $("#cpW").innerHTML = winPill(
            winCell(S.A.ctxPrecision, S.B.ctxPrecision)
          );
          $("#crW").innerHTML = winPill(winCell(S.A.ctxRecall, S.B.ctxRecall));
          $("#laW").innerHTML = winPill(winCell(-latest.latA, -latest.latB)); // 낮을수록 좋음
          $("#toW").innerHTML = winPill(winCell(-latest.tokA, -latest.tokB)); // 낮을수록 좋음

          const verdict = judge(latest);
          $("#jA").textContent =
            verdict === "A" ? "WIN" : verdict === "=" ? "TIE" : "";
          $("#jB").textContent =
            verdict === "B" ? "WIN" : verdict === "=" ? "TIE" : "";
          $("#jW").innerHTML = winPill(verdict);
        } else {
          // 싱글 모드에서는 우세 표시 없음
          ["#faW", "#arW", "#cpW", "#crW", "#laW", "#toW", "#jA", "#jB", "#jW"].forEach(
            (id) => ($(id).textContent = "-")
          );
        }

        // 하단 로그 테이블 추가
        const tbody = $("#runTable tbody");
        const row = document.createElement("tr");
        
        if (state.isSingleMode) {
          row.innerHTML = `
            <td>${state.runs.length}</td>
            <td>${escapeHtml(latest.query).slice(0, 120)}</td>
            <td>${escapeHtml(latest.promptA.name)}</td>
            <td class="b-column">-</td>
            <td class="metric">${S.A.faithfulness.toFixed(2)}</td>
            <td class="metric">${S.A.relevancy.toFixed(2)}</td>
            <td class="metric">${S.A.ctxPrecision.toFixed(2)}</td>
            <td class="metric">${S.A.ctxRecall.toFixed(2)}</td>
            <td class="b-column">-</td>
            <td class="b-column">-</td>
            <td class="metric">${latest.latA}</td>
            <td class="b-column">-</td>
            <td class="metric">${latest.tokA}</td>
            <td class="b-column">-</td>
          `;
        } else {
          const verdict = judge(latest);
          row.innerHTML = `
            <td>${state.runs.length}</td>
            <td>${escapeHtml(latest.query).slice(0, 120)}</td>
            <td>${escapeHtml(latest.promptA.name)}</td>
            <td class="b-column">${escapeHtml(latest.promptB.name)}</td>
            <td class="metric">${S.A.faithfulness.toFixed(
              2
            )} / ${S.B.faithfulness.toFixed(2)}</td>
            <td class="metric">${S.A.relevancy.toFixed(2)} / ${S.B.relevancy.toFixed(
              2
            )}</td>
            <td class="metric">${S.A.ctxPrecision.toFixed(
              2
            )} / ${S.B.ctxPrecision.toFixed(2)}</td>
            <td class="metric">${S.A.ctxRecall.toFixed(2)} / ${S.B.ctxRecall.toFixed(
              2
            )}</td>
            <td class="b-column metric">${latest.sim}%</td>
            <td class="b-column">${winPill(verdict)}</td>
            <td class="metric">${latest.latA}</td>
            <td class="b-column metric">${latest.latB}</td>
            <td class="metric">${latest.tokA}</td>
            <td class="b-column metric">${latest.tokB}</td>
          `;
        }
        tbody.prepend(row);

        // 요약
        renderSummary();
        $("#runCount").textContent = "runs: " + state.runs.length;
      }

      function renderSummary() {
        if (state.runs.length === 0) {
          $("#summary").textContent = "";
          return;
        }
        const avg = (arr) => arr.reduce((a, b) => a + b, 0) / arr.length;
        const faA = avg(state.runs.map((r) => r.scores.A.faithfulness));
        const arA = avg(state.runs.map((r) => r.scores.A.relevancy));
        const cpA = avg(state.runs.map((r) => r.scores.A.ctxPrecision));
        const crA = avg(state.runs.map((r) => r.scores.A.ctxRecall));
        const latA = avg(state.runs.map((r) => r.latA));
        const tokA = avg(state.runs.map((r) => r.tokA));

        let summaryContent = `
        <div class="card">
          <strong>집계 요약</strong>
          <div class="kv" style="margin-top:8px">
            <div>평균 Faithfulness</div><div>${faA.toFixed(3)}</div>
            <div>평균 Relevancy</div><div>${arA.toFixed(3)}</div>
            <div>평균 Ctx Precision</div><div>${cpA.toFixed(3)}</div>
            <div>평균 Ctx Recall</div><div>${crA.toFixed(3)}</div>
            <div>평균 Latency(ms)</div><div>${latA.toFixed(0)}</div>
            <div>평균 Tokens</div><div>${tokA.toFixed(0)}</div>`;

        if (!state.isSingleMode) {
          const faB = avg(state.runs.map((r) => r.scores.B.faithfulness));
          const arB = avg(state.runs.map((r) => r.scores.B.relevancy));
          const cpB = avg(state.runs.map((r) => r.scores.B.ctxPrecision));
          const crB = avg(state.runs.map((r) => r.scores.B.ctxRecall));
          const sim = avg(state.runs.map((r) => r.sim));
          const latB = avg(state.runs.map((r) => r.latB));
          const tokB = avg(state.runs.map((r) => r.tokB));
          const wins = state.runs.map(judge);
          const aW = wins.filter((w) => w === "A").length;
          const bW = wins.filter((w) => w === "B").length;
          const ties = wins.filter((w) => w === "=").length;

          summaryContent = `
          <div class="card">
            <strong>집계 요약</strong>
            <div class="kv" style="margin-top:8px">
              <div>평균 Faithfulness</div><div>${faA.toFixed(3)} / ${faB.toFixed(3)}</div>
              <div>평균 Relevancy</div><div>${arA.toFixed(3)} / ${arB.toFixed(3)}</div>
              <div>평균 Ctx Precision</div><div>${cpA.toFixed(3)} / ${cpB.toFixed(3)}</div>
              <div>평균 Ctx Recall</div><div>${crA.toFixed(3)} / ${crB.toFixed(3)}</div>
              <div>평균 유사도</div><div>${sim.toFixed(1)}%</div>
              <div>평균 Latency(ms)</div><div>${latA.toFixed(0)} / ${latB.toFixed(0)}</div>
              <div>평균 Tokens</div><div>${tokA.toFixed(0)} / ${tokB.toFixed(0)}</div>
              <div>승부</div><div>A:${aW} · B:${bW} · Tie:${ties}</div>
            </div>
          </div>`;
        }

        summaryContent += `
          </div>
        </div>`;

        $("#summary").innerHTML = summaryContent;
      }

      // CSV 내보내기
      function exportCSV() {
        if (state.runs.length === 0) {
          alert("내보낼 실행 결과가 없습니다.");
          return;
        }

        let header, rows;
        
        if (state.isSingleMode) {
          header = [
            "index",
            "query",
            "promptA",
            "faithA",
            "relA",
            "ctxPrecA",
            "ctxRecA",
            "latA_ms",
            "tokA",
          ];
          rows = [header.join(",")];
          state.runs.forEach((r, i) => {
            rows.push(
              [
                i + 1,
                csvSafe(r.query),
                csvSafe(r.promptA.name),
                r.scores.A.faithfulness,
                r.scores.A.relevancy,
                r.scores.A.ctxPrecision,
                r.scores.A.ctxRecall,
                r.latA,
                r.tokA,
              ].join(",")
            );
          });
        } else {
          header = [
            "index",
            "query",
            "promptA",
            "promptB",
            "faithA",
            "faithB",
            "relA",
            "relB",
            "ctxPrecA",
            "ctxPrecB",
            "ctxRecA",
            "ctxRecB",
            "similarity",
            "winner",
            "latA_ms",
            "latB_ms",
            "tokA",
            "tokB",
          ];
          rows = [header.join(",")];
          state.runs.forEach((r, i) => {
            rows.push(
              [
                i + 1,
                csvSafe(r.query),
                csvSafe(r.promptA.name),
                csvSafe(r.promptB.name),
                r.scores.A.faithfulness,
                r.scores.B.faithfulness,
                r.scores.A.relevancy,
                r.scores.B.relevancy,
                r.scores.A.ctxPrecision,
                r.scores.B.ctxPrecision,
                r.scores.A.ctxRecall,
                r.scores.B.ctxRecall,
                r.sim,
                judge(r),
                r.latA,
                r.latB,
                r.tokA,
                r.tokB,
              ].join(",")
            );
          });
        }

        const blob = new Blob([rows.join("\n")], {
          type: "text/csv;charset=utf-8",
        });
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        const modePrefix = state.isSingleMode ? "single" : "ab";
        a.download = `prompt_${modePrefix}_results_${new Date()
          .toISOString()
          .slice(0, 19)
          .replace(/[:T]/g, "-")}.csv`;
        document.body.appendChild(a);
        a.click();
        a.remove();
      }

      // 이벤트 리스너 등록
      function setupEventListeners() {
        $("#btnRun").addEventListener("click", async () => {
          const promptA = {
            name: $("#promptA_name").value.trim() || "A",
            tpl: $("#promptA_tpl").value.trim(),
          };
          
          let promptB = null;
          if (!state.isSingleMode) {
            promptB = {
              name: $("#promptB_name").value.trim() || "B",
              tpl: $("#promptB_tpl").value.trim(),
            };
          }
          
          const query = $("#userQuery").value.trim();
          if (!query) {
            alert("사용자 질문을 입력하세요.");
            return;
          }

          // LLM 호출 (실전에서는 백엔드 호출로 교체)
          const resA = await callLLM(
            $("#modelName").value || "internal-llm",
            promptA.tpl,
            query
          );
          
          let resB = null;
          if (!state.isSingleMode) {
            resB = await callLLM(
              $("#modelName").value || "internal-llm",
              promptB.tpl,
              query
            );
          }

          // RAGAS류 점수 계산 (실전에서는 서버에서 계산)
          const scores = await evalRAGAS(resA.text, resB ? resB.text : null);
          const sim = !state.isSingleMode ? naiveSimilarity(resA.text, resB.text) : 0;

          const run = {
            time: Date.now(),
            query,
            promptA,
            promptB: promptB || { name: "", tpl: "" },
            ansA: resA.text,
            ansB: resB ? resB.text : "",
            latA: resA.latency,
            latB: resB ? resB.latency : 0,
            tokA: resA.tokens,
            tokB: resB ? resB.tokens : 0,
            sim,
            scores,
          };
          state.runs.push(run);
          renderLatest(run);
        });

        $("#btnClear").addEventListener("click", () => {
          state.runs = [];
          $("#runTable tbody").innerHTML = "";
          $("#summary").textContent = "";
          $("#runCount").textContent = "runs: 0";
          // 상단 카드 초기화
          ["latA", "latB", "tokA", "tokB", "ansA", "ansB", "simScore"].forEach(
            (id) => ($("#" + id).textContent = "-")
          );
          $("#simBar").style.width = "0%";
          [
            "faA",
            "faB",
            "arA",
            "arB",
            "cpA",
            "cpB",
            "crA",
            "crB",
            "laA",
            "laB",
            "toA",
            "toB",
            "faW",
            "arW",
            "cpW",
            "crW",
            "laW",
            "toW",
            "jA",
            "jB",
            "jW",
          ].forEach((id) => ($("#" + id).textContent = "-"));
        });

        $("#btnExport").addEventListener("click", exportCSV);

        // 결과보기 버튼 - 모드에 따라 적절한 페이지로 이동
        $("#btnResultView").addEventListener("click", () => {
          if (state.isSingleMode) {
            // Single Mode일 때 single_result_view.html로 이동
            location.href = 'single_result_view.html';
          } else {
            // A/B Mode일 때 result_view.html로 이동
            location.href = 'result_view.html';
          }
        });
      }

      // 보조 함수들
      function escapeHtml(s) {
        if (!s) return "";
        return s.replace(
          /[&<>"']/g,
          (m) =>
            ({
              "&": "&amp;",
              "<": "&lt;",
              ">": "&gt;",
              '"': "&quot;",
              "'": "&#39;",
            }[m])
        );
      }
      
      function csvSafe(s) {
        if (s === undefined || s === null) return "";
        s = String(s);
        if (/[",\n]/.test(s)) return `"${s.replace(/"/g, '""')}"`;
        return s;
      }

      // 페이지 로드 시 초기화
      document.addEventListener("DOMContentLoaded", () => {
        console.log("페이지 로드됨, 초기화 시작");
        initializeApp();
        setupEventListeners();
      });

      // 페이지를 떠날 때 state 저장
      window.addEventListener("beforeunload", () => {
        localStorage.setItem("ab_runs", JSON.stringify(state.runs));
        localStorage.setItem("ab_mode", JSON.stringify(state.isSingleMode));
      });

      // 페이지 로드 시 저장된 state 복원
      window.addEventListener("load", () => {
        const savedRuns = localStorage.getItem("ab_runs");
        const savedMode = localStorage.getItem("ab_mode");
        
        if (savedRuns) {
          try {
            state.runs = JSON.parse(savedRuns);
            // 저장된 실행 결과들을 테이블에 복원
            state.runs.forEach((run, index) => {
              const tbody = $("#runTable tbody");
              const row = document.createElement("tr");
              
              if (state.isSingleMode) {
                row.innerHTML = `
                  <td>${index + 1}</td>
                  <td>${escapeHtml(run.query).slice(0, 120)}</td>
                  <td>${escapeHtml(run.promptA.name)}</td>
                  <td class="b-column">-</td>
                  <td class="metric">${run.scores.A.faithfulness.toFixed(2)}</td>
                  <td class="metric">${run.scores.A.relevancy.toFixed(2)}</td>
                  <td class="metric">${run.scores.A.ctxPrecision.toFixed(2)}</td>
                  <td class="metric">${run.scores.A.ctxRecall.toFixed(2)}</td>
                  <td class="b-column">-</td>
                  <td class="b-column">-</td>
                  <td class="metric">${run.latA}</td>
                  <td class="b-column">-</td>
                  <td class="metric">${run.tokA}</td>
                  <td class="b-column">-</td>
                `;
              } else {
                const verdict = judge(run);
                row.innerHTML = `
                  <td>${index + 1}</td>
                  <td>${escapeHtml(run.query).slice(0, 120)}</td>
                  <td>${escapeHtml(run.promptA.name)}</td>
                  <td class="b-column">${escapeHtml(run.promptB.name)}</td>
                  <td class="metric">${run.scores.A.faithfulness.toFixed(2)} / ${run.scores.B.faithfulness.toFixed(2)}</td>
                  <td class="metric">${run.scores.A.relevancy.toFixed(2)} / ${run.scores.B.relevancy.toFixed(2)}</td>
                  <td class="metric">${run.scores.A.ctxPrecision.toFixed(2)} / ${run.scores.B.ctxPrecision.toFixed(2)}</td>
                  <td class="metric">${run.scores.A.ctxRecall.toFixed(2)} / ${run.scores.B.ctxRecall.toFixed(2)}</td>
                  <td class="b-column metric">${run.sim}%</td>
                  <td class="b-column">${winPill(verdict)}</td>
                  <td class="metric">${run.latA}</td>
                  <td class="b-column metric">${run.latB}</td>
                  <td class="metric">${run.tokA}</td>
                  <td class="b-column metric">${run.tokB}</td>
                `;
              }
              tbody.appendChild(row);
            });
            
            renderSummary();
            $("#runCount").textContent = "runs: " + state.runs.length;
          } catch (e) {
            console.error("저장된 실행 결과 복원 실패:", e);
          }
        }
        
        if (savedMode) {
          try {
            const isSingleMode = JSON.parse(savedMode);
            if (isSingleMode !== state.isSingleMode) {
              toggleMode(); // 저장된 모드로 전환
            }
          } catch (e) {
            console.error("저장된 모드 복원 실패:", e);
          }
        }
      });
    </script>
  </body>
</html>