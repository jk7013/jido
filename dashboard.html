<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Prompt A/B í…ŒìŠ¤íŠ¸ ëŒ€ì‹œë³´ë“œ</title>
  <link rel="stylesheet" href="css/jido-theme.css" />
</head>

  <body>
    <div id="header-placeholder"></div>
    <div id="dialog-placeholder"></div>

    <script>
      fetch("components/header.html")
        .then((res) => res.text())
        .then((html) => {
          document.getElementById("header-placeholder").innerHTML = html;
          // í—¤ë” ë¡œë“œ í›„ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¬ë“±ë¡
          setupHeaderEventListeners();
        })
        .catch((error) => {
          console.error("í—¤ë” ë¡œë”© ì‹¤íŒ¨:", error);
          // ëŒ€ì•ˆ: ì§ì ‘ í—¤ë” HTML ì‚½ì…
          document.getElementById("header-placeholder").innerHTML = `
            <header>
              <h1>Prompt A/B í…ŒìŠ¤íŠ¸ ëŒ€ì‹œë³´ë“œ</h1>
              <div class="right">
                <button class="ghost" id="btnExport">CSVë¡œ ë‚´ë³´ë‚´ê¸°</button>
                <button class="ghost" id="btnResultView">ê²°ê³¼ ë³´ê¸°</button>
                <button class="ghost" id="btnLogView">
                  ë¡œê·¸ ë³´ê¸°
                </button>
                <button
                  class="ghost"
                  onclick="openGitLabDialog()"
                >
                  <img
                    src="img/gitlab.svg"
                    alt="GitLab"
                    style="width:16px; vertical-align:middle; margin-right:4px;"
                  />
                  GitLab
                </button>
                <span class="muted" id="runCount">runs: 0</span>
              </div>
            </header>
          `;
          // ëŒ€ì•ˆ í—¤ë” ë¡œë“œ í›„ì—ë„ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
          setupHeaderEventListeners();
        });

      // GitLab ë‹¤ì´ì–¼ë¡œê·¸ ë¡œë“œ
      fetch("components/gitlab-commit-dialog.html")
        .then((res) => res.text())
        .then((html) => {
          document.getElementById("dialog-placeholder").innerHTML = html;
        })
        .catch((error) => {
          console.error("ë‹¤ì´ì–¼ë¡œê·¸ ë¡œë”© ì‹¤íŒ¨:", error);
          // ëŒ€ì•ˆ: ì§ì ‘ ë‹¤ì´ì–¼ë¡œê·¸ HTML ì‚½ì…
          document.getElementById("dialog-placeholder").innerHTML = `
            <!-- GitLab ì»¤ë°‹ ë‹¤ì´ì–¼ë¡œê·¸ -->
            <div id="gitlab-commit-dialog" class="dialog-overlay" style="display: none;">
              <div class="dialog-content">
                <div class="dialog-header">
                  <h2 class="dialog-title">Commit to GitLab</h2>
                  <p class="dialog-description">ë³€ê²½ëœ í”„ë¡¬í”„íŠ¸ë‚˜ ì„¤ì •ì„ GitLabì— ì»¤ë°‹í•˜ì„¸ìš”.</p>
                </div>

                <div class="dialog-body">
                  <div class="form-group">
                    <label for="commit-message">ì»¤ë°‹ ë©”ì‹œì§€</label>
                    <input 
                      type="text" 
                      id="commit-message" 
                      placeholder="feat: update RAG prompt version (ì˜ˆ: improved evaluation prompt)" 
                      class="form-input"
                      autofocus
                    />
                  </div>

                  <div class="form-group">
                    <label for="commit-description">ì„¤ëª… (ì„ íƒ)</label>
                    <textarea 
                      id="commit-description" 
                      placeholder="ë³€ê²½ ì´ìœ ë‚˜ ì„¸ë¶€ ìˆ˜ì •ì‚¬í•­ì„ ê°„ë‹¨íˆ ì ì–´ì£¼ì„¸ìš”."
                      class="form-textarea"
                      rows="3"
                    ></textarea>
                  </div>

                  <div class="branch-info">
                    <span class="branch-label">Branch</span>
                    <div class="branch-name">
                      main
                      <span class="branch-chevron">ğŸ”½</span>
                    </div>
                  </div>
                </div>

                <div class="dialog-footer">
                  <button class="btn btn-secondary" onclick="closeGitLabDialog()">ì·¨ì†Œ</button>
                  <button class="btn btn-primary" onclick="handleGitLabCommit()">ì»¤ë°‹</button>
                </div>
              </div>
            </div>

            <!-- í† ìŠ¤íŠ¸ ì•Œë¦¼ -->
            <div id="toast-container" class="toast-container"></div>
          `;
        });
    </script>

    <!-- GitLab ë‹¤ì´ì–¼ë¡œê·¸ JavaScript -->
    <script>
      // GitLab ì»¤ë°‹ ë‹¤ì´ì–¼ë¡œê·¸ JavaScript

      // ë‹¤ì´ì–¼ë¡œê·¸ ì—´ê¸°
      function openGitLabDialog() {
        const dialog = document.getElementById('gitlab-commit-dialog');
        if (dialog) {
          dialog.style.display = 'flex';
          // ì• ë‹ˆë©”ì´ì…˜ì„ ìœ„í•´ ì•½ê°„ì˜ ì§€ì—° í›„ show í´ë˜ìŠ¤ ì¶”ê°€
          setTimeout(() => {
            dialog.classList.add('show');
          }, 10);
          
          // ì»¤ë°‹ ë©”ì‹œì§€ ì…ë ¥ í•„ë“œì— í¬ì»¤ìŠ¤
          const commitMessage = document.getElementById('commit-message');
          if (commitMessage) {
            commitMessage.focus();
          }
        }
      }

      // ë‹¤ì´ì–¼ë¡œê·¸ ë‹«ê¸°
      function closeGitLabDialog() {
        const dialog = document.getElementById('gitlab-commit-dialog');
        if (dialog) {
          dialog.classList.remove('show');
          // ì• ë‹ˆë©”ì´ì…˜ ì™„ë£Œ í›„ ìˆ¨ê¹€
          setTimeout(() => {
            dialog.style.display = 'none';
          }, 200);
        }
      }

      // GitLab ì»¤ë°‹ ì²˜ë¦¬
      async function handleGitLabCommit() {
        const commitMessage = document.getElementById('commit-message');
        const commitDescription = document.getElementById('commit-description');
        
        if (!commitMessage || !commitMessage.value.trim()) {
          showToast('ì»¤ë°‹ ë©”ì‹œì§€ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
          return;
        }
        
        const commitBtn = document.querySelector('.btn-primary');
        if (commitBtn) {
          commitBtn.disabled = true;
          commitBtn.innerHTML = '<span class="spinner"></span> ì»¤ë°‹ ì¤‘...';
        }
        
        try {
          // ì‹¤ì œ GitLab API í˜¸ì¶œ (í˜„ì¬ëŠ” ì‹œë®¬ë ˆì´ì…˜)
          const response = await simulateGitLabCommit({
            message: commitMessage.value.trim(),
            description: commitDescription ? commitDescription.value.trim() : '',
            branch: 'main'
          });
          
          if (response.success) {
            showToast('âœ… Commit pushed to GitLab', 'success');
            closeGitLabDialog();
            
            // í¼ ì´ˆê¸°í™”
            if (commitMessage) commitMessage.value = '';
            if (commitDescription) commitDescription.value = '';
          } else {
            showToast('âŒ Commit failed. Please check GitLab token or branch.', 'error');
          }
        } catch (error) {
          showToast('âŒ Commit failed. Please check GitLab token or branch.', 'error');
        } finally {
          if (commitBtn) {
            commitBtn.disabled = false;
            commitBtn.innerHTML = 'ì»¤ë°‹';
          }
        }
      }

      // GitLab ì»¤ë°‹ ì‹œë®¬ë ˆì´ì…˜ (ì‹¤ì œ API ì—°ë™ ì‹œ êµì²´)
      async function simulateGitLabCommit(data) {
        // 2ì´ˆ ì§€ì—°ìœ¼ë¡œ ì‹¤ì œ API í˜¸ì¶œ ì‹œë®¬ë ˆì´ì…˜
        await new Promise(resolve => setTimeout(resolve, 2000));
        
        // 90% ì„±ê³µë¥ ë¡œ ì‹œë®¬ë ˆì´ì…˜
        if (Math.random() > 0.1) {
          return {
            success: true,
            commitId: 'abc123def456',
            message: 'Commit successful'
          };
        } else {
          return {
            success: false,
            error: 'Network error or permission denied'
          };
        }
      }

      // í† ìŠ¤íŠ¸ ì•Œë¦¼ í‘œì‹œ
      function showToast(message, type = 'success') {
        const container = document.getElementById('toast-container');
        if (!container) return;
        
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        
        const icon = type === 'success' ? 'âœ…' : 'âŒ';
        toast.innerHTML = `
          <span class="toast-icon">${icon}</span>
          <span>${message}</span>
        `;
        
        container.appendChild(toast);
        
        // ì• ë‹ˆë©”ì´ì…˜ì„ ìœ„í•´ ì•½ê°„ì˜ ì§€ì—° í›„ show í´ë˜ìŠ¤ ì¶”ê°€
        setTimeout(() => {
          toast.classList.add('show');
        }, 10);
        
        // 3ì´ˆ í›„ ìë™ ì œê±°
        setTimeout(() => {
          toast.classList.remove('show');
          setTimeout(() => {
            if (toast.parentNode) {
              toast.parentNode.removeChild(toast);
            }
          }, 300);
        }, 3000);
      }

      // í‚¤ë³´ë“œ ë‹¨ì¶•í‚¤ ì²˜ë¦¬
      function handleKeyboardShortcuts(event) {
        // Ctrl + Enterë¡œ ì»¤ë°‹ ì‹¤í–‰
        if (event.ctrlKey && event.key === 'Enter') {
          const dialog = document.getElementById('gitlab-commit-dialog');
          if (dialog && dialog.style.display !== 'none') {
            event.preventDefault();
            handleGitLabCommit();
          }
        }
        
        // ESCë¡œ ë‹¤ì´ì–¼ë¡œê·¸ ë‹«ê¸°
        if (event.key === 'Escape') {
          const dialog = document.getElementById('gitlab-commit-dialog');
          if (dialog && dialog.style.display !== 'none') {
            closeGitLabDialog();
          }
        }
      }

      // ì˜¤ë²„ë ˆì´ í´ë¦­ìœ¼ë¡œ ë‹¤ì´ì–¼ë¡œê·¸ ë‹«ê¸°
      function handleOverlayClick(event) {
        if (event.target.classList.contains('dialog-overlay')) {
          closeGitLabDialog();
        }
      }

      // ì´ˆê¸°í™”
      document.addEventListener('DOMContentLoaded', function() {
        // í‚¤ë³´ë“œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        document.addEventListener('keydown', handleKeyboardShortcuts);
        
        // ì˜¤ë²„ë ˆì´ í´ë¦­ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        document.addEventListener('click', handleOverlayClick);
        
        // ë‹¤ì´ì–¼ë¡œê·¸ê°€ ì´ë¯¸ DOMì— ìˆë‹¤ë©´ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
        const dialog = document.getElementById('gitlab-commit-dialog');
        if (dialog) {
          // ë‹¤ì´ì–¼ë¡œê·¸ ë‚´ë¶€ í´ë¦­ ì‹œ ì´ë²¤íŠ¸ ì „íŒŒ ì¤‘ì§€
          dialog.addEventListener('click', function(event) {
            event.stopPropagation();
          });
        }
      });
    </script>

    <div class="wrap">
      <!-- ì¢Œ: ì»¨íŠ¸ë¡¤ -->
      <section class="panel">
        <h2>ì‹¤í–‰ ì»¨íŠ¸ë¡¤</h2>
        <div class="content">
          <!-- í† ê¸€ ìŠ¤ìœ„ì¹˜ -->
          <div class="toggle-container">
            <span class="toggle-label">Single Mode</span>
            <div class="toggle-switch" id="modeToggle">
              <div class="toggle-slider"></div>
            </div>
            <span class="toggle-label">A/B Mode</span>
          </div>
          
          <div class="prompt-row">
            <div class="prompt-a-container">
              <label>í”„ë¡¬í”„íŠ¸ A (ë²„ì „/ì„¤ëª…)</label>
              <input
                type="text"
                id="promptA_name"
                placeholder="ì˜ˆ: legal_rag_v0.3.4 (strict)"
              />
              <label>í”„ë¡¬í”„íŠ¸ A í…œí”Œë¦¿</label>
              <textarea
                id="promptA_tpl"
                placeholder="ì˜ˆ: ì‹œìŠ¤í…œ ì§€ì¹¨ + ìš”ì•½/ê·¼ê±° ì œì‹œ ìš”êµ¬..."
              ></textarea>
            </div>
            <div class="prompt-b-container">
              <label>í”„ë¡¬í”„íŠ¸ B (ë²„ì „/ì„¤ëª…)</label>
              <input
                type="text"
                id="promptB_name"
                placeholder="ì˜ˆ: legal_rag_v0.3.5 (concise)"
              />
              <label>í”„ë¡¬í”„íŠ¸ B í…œí”Œë¦¿</label>
              <textarea
                id="promptB_tpl"
                placeholder="ì˜ˆ: í†¤/í˜•ì‹ ë³€ê²½ í…œí”Œë¦¿..."
              ></textarea>
            </div>
          </div>

          <div class="row" style="margin-top: 10px">
            <div>
              <label>ì‚¬ìš©ì ì§ˆë¬¸</label>
              <input
                type="text"
                id="userQuery"
                placeholder='ì˜ˆ: "íšŒì‚¬ì°¨ë¥¼ íƒ€ê³  ê°€ë©´ ì‚¬ê·œì— ì–´ê¸‹ë‚˜?"'
              />
              <div class="hint">
                ì—¬ëŸ¬ ê±´ í…ŒìŠ¤íŠ¸í•˜ë ¤ë©´ í…ŒìŠ¤íŠ¸ì…‹ ëª¨ë“œ(í•˜ë‹¨ í‘œ ìš°ì¸¡ ìƒë‹¨ ë²„íŠ¼)ë¡œ
                í™•ì¥ ê°€ëŠ¥
              </div>
            </div>
            <div>
              <label>í‰ê°€ ì˜µì…˜</label>
              <select id="judgeMode">
                <option value="auto">Auto Judge (LLM ê¸°ë°˜)</option>
                <option value="heuristic">Heuristic (ìœ ì‚¬ë„/ê¸¸ì´/í¬ë§·)</option>
              </select>
              <label style="margin-top: 8px">ëª¨ë¸/ì—”ë“œí¬ì¸íŠ¸ (í‘œê¸°ìš©)</label>
              <input
                type="text"
                id="modelName"
                placeholder="ì˜ˆ: internal-llm-rag@v2"
              />
            </div>
          </div>

          <div class="exec-controls">
            <button id="btnRun">A/B ì‹¤í–‰</button>
            <button class="ghost" id="btnClear">í™”ë©´ ì´ˆê¸°í™”</button>
          </div>
        </div>
      </section>

      <!-- ìš°: ìµœê·¼ ì‹¤í–‰ ë¹„êµ ì¹´ë“œ -->
      <section class="panel">
        <h2 id="resultTitle">ìµœê·¼ ì‹¤í–‰ ë¹„êµ</h2>
        <div class="content">
          <div class="cards" id="cards">
            <div class="card" id="cardA">
              <div>
                <strong id="labA">Prompt A</strong
                ><span class="badge" id="verA">-</span>
              </div>
              <div class="kv">
                <div>Latency</div>
                <div class="metric" id="latA">-</div>
                <div>Tokens</div>
                <div class="metric" id="tokA">-</div>
                <div>Answer</div>
                <div><pre id="ansA">-</pre></div>
              </div>
            </div>
            <div class="card card-b" id="cardB">
              <div>
                <strong id="labB">Prompt B</strong
                ><span class="badge" id="verB">-</span>
              </div>
              <div class="kv">
                <div>Latency</div>
                <div class="metric" id="latB">-</div>
                <div>Tokens</div>
                <div class="metric" id="tokB">-</div>
                <div>Answer</div>
                <div><pre id="ansB">-</pre></div>
              </div>
            </div>
          </div>

          <div class="similarity-section" style="margin-top: 10px">
            <label>í…ìŠ¤íŠ¸ ìœ ì‚¬ë„ (A vs B)</label>
            <div class="bar"><span id="simBar" style="width: 0%"></span></div>
            <div class="metric" id="simScore">-</div>
          </div>

          <div style="margin-top: 10px">
            <table id="metricTable" class="metric-table">
              <thead>
                <tr>
                  <th>ì§€í‘œ</th>
                  <th>A</th>
                  <th>B</th>
                  <th>ìš°ì„¸</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td>Faithfulness</td>
                  <td class="metric" id="faA">-</td>
                  <td class="metric" id="faB">-</td>
                  <td id="faW">-</td>
                </tr>
                <tr>
                  <td>Answer Relevancy</td>
                  <td class="metric" id="arA">-</td>
                  <td class="metric" id="arB">-</td>
                  <td id="arW">-</td>
                </tr>
                <tr>
                  <td>Context Precision</td>
                  <td class="metric" id="cpA">-</td>
                  <td class="metric" id="cpB">-</td>
                  <td id="cpW">-</td>
                </tr>
                <tr>
                  <td>Context Recall</td>
                  <td class="metric" id="crA">-</td>
                  <td class="metric" id="crB">-</td>
                  <td id="crW">-</td>
                </tr>
                <tr>
                  <td>Latency (ms)</td>
                  <td class="metric" id="laA">-</td>
                  <td class="metric" id="laB">-</td>
                  <td id="laW">-</td>
                </tr>
                <tr>
                  <td>Tokens</td>
                  <td class="metric" id="toA">-</td>
                  <td class="metric" id="toB">-</td>
                  <td id="toW">-</td>
                </tr>
                <tr>
                  <td>Judge Verdict</td>
                  <td id="jA">-</td>
                  <td id="jB">-</td>
                  <td id="jW">-</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- ì „ì²´ ì‹¤í–‰ ë¡œê·¸/ì§‘ê³„ -->
      <section class="panel" style="grid-column: 1 / -1">
        <h2>ì‹¤í–‰ ë¡œê·¸ & ì§‘ê³„</h2>
        <div class="content">
          <table id="runTable" class="log-table">
            <thead>
              <tr>
                <th>#</th>
                <th>Query</th>
                <th>Prompt A</th>
                <th class="b-column">Prompt B</th>
                <th>Faith.</th>
                <th>Rel.</th>
                <th>CtxP</th>
                <th>CtxR</th>
                <th class="b-column">Sim</th>
                <th class="b-column">Winner</th>
                <th>LatencyA</th>
                <th class="b-column">LatencyB</th>
                <th>TokensA</th>
                <th class="b-column">TokensB</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>

          <div style="margin-top: 12px" id="summary"></div>
        </div>
      </section>
    </div>

    <footer>
      A/B í…ŒìŠ¤íŠ¸ í™”ë©´ ì˜ˆì‹œ â€” í”„ë¡¬í”„íŠ¸ ë²„ì „ì€ GitLab, ì‹¤í–‰/ì§€í‘œ ì €ì¥ì€ MLflow
      ì—°ë™ ì¶”ì²œ Â· CSV ë‚´ë³´ë‚´ê¸°ëŠ” ìš°ì¸¡ ìƒë‹¨ ë²„íŠ¼
    </footer>

    <script>
      /** ******************************
       * ë°ëª¨/ìŠ¤ì¼ˆë ˆí†¤ JS
       * - TODO ë¶€ë¶„ì— ë°±ì—”ë“œ ì—°ë™(LLM í˜¸ì¶œ, RAGAS ì ìˆ˜ ê³„ì‚°) ë¶™ì´ë©´ ì‹¤ì „ì—ì„œ ë°”ë¡œ ì‚¬ìš© ê°€ëŠ¥
       *********************************/

      // ìƒíƒœ
      const state = {
        runs: [], // ê° ì‹¤í–‰ì˜ ê¸°ë¡
        isSingleMode: false, // ëª¨ë“œ ìƒíƒœ
      };

      // ìœ í‹¸
      const $ = (q) => document.querySelector(q);
      const fmt = (v) => (v === null || v === undefined ? "-" : v);
      const winPill = (w) =>
        w === "A"
          ? '<span class="pill ok">A</span>'
          : w === "B"
          ? '<span class="pill bad">B</span>'
          : '<span class="pill meh">=</span>';

      // ëª¨ë“œ í† ê¸€ ê¸°ëŠ¥
      function toggleMode() {
        state.isSingleMode = !state.isSingleMode;
        const body = document.body;
        const toggle = $("#modeToggle");
        const resultTitle = $("#resultTitle");
        const runButton = $("#btnRun");
        
        console.log("í† ê¸€ ëª¨ë“œ ë³€ê²½:", state.isSingleMode ? "Single" : "A/B");
        
        if (state.isSingleMode) {
          body.classList.add("single-mode");
          toggle.classList.remove("active");
          resultTitle.textContent = "ìµœê·¼ ì‹¤í–‰ ê²°ê³¼";
          runButton.textContent = "ì‹¤í–‰";
        } else {
          body.classList.remove("single-mode");
          toggle.classList.add("active");
          resultTitle.textContent = "ìµœê·¼ ì‹¤í–‰ ë¹„êµ";
          runButton.textContent = "A/B ì‹¤í–‰";
        }
      }

      // ì´ˆê¸°í™” í•¨ìˆ˜
      function initializeApp() {
        // í† ê¸€ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        const toggleButton = $("#modeToggle");
        if (toggleButton) {
          toggleButton.addEventListener("click", toggleMode);
          console.log("í† ê¸€ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡ë¨");
        }
        
        // ì´ˆê¸° ëª¨ë“œ ì„¤ì • (A/B ëª¨ë“œë¡œ ì‹œì‘)
        state.isSingleMode = false;
        document.body.classList.remove("single-mode");
        $("#modeToggle").classList.add("active");
      }

      // ë°ëª¨ìš© ëœë¤(ì‹¤ì „ì—ì„œëŠ” ì œê±°)
      function rand(min, max) {
        return Math.round(min + Math.random() * (max - min));
      }
      function randScore() {
        return Math.round((0.6 + Math.random() * 0.4) * 100) / 100;
      } // 0.6~1.0

      // TODO: ì—¬ê¸°ì— ì‹¤ì œ LLM/RAG í˜¸ì¶œì„ ë¶™ì¸ë‹¤.
      async function callLLM(endpointName, promptTemplate, userQuery) {
        // ì˜ˆì‹œ: ì‹¤ì œë¡œëŠ” fetch("/api/run", {method:"POST", body: JSON.stringify({...})})
        const start = performance.now();
        // ì‘ë‹µ ë³¸ë¬¸ì€ ë°ëª¨ í…ìŠ¤íŠ¸
        const text = `[${endpointName}] "${userQuery}"ì— ëŒ€í•œ ì‘ë‹µ ì˜ˆì‹œ. í…œí”Œë¦¿ ì¼ë¶€: ${promptTemplate.slice(
          0,
          40
        )}...`;
        const latency = Math.round(performance.now() - start) + rand(150, 800);
        const tokens = rand(120, 480);
        return { text, latency, tokens };
      }

      // TODO: RAGAS ë©”íŠ¸ë¦­ ê³„ì‚°ì„ ë¶™ì¸ë‹¤(ë°±ì—”ë“œì—ì„œ ê³„ì‚° í›„ ì ìˆ˜ë§Œ ë¦¬í„´ ê¶Œì¥)
      // ì—¬ê¸°ì„  ë°ëª¨ë¡œ ì ìˆ˜ë¥¼ ìƒì„±
      async function evalRAGAS(answerA, answerB) {
        if (state.isSingleMode) {
          return {
            A: {
              faithfulness: randScore(),
              relevancy: randScore(),
              ctxPrecision: randScore(),
              ctxRecall: randScore(),
            },
          };
        } else {
          return {
            A: {
              faithfulness: randScore(),
              relevancy: randScore(),
              ctxPrecision: randScore(),
              ctxRecall: randScore(),
            },
            B: {
              faithfulness: randScore(),
              relevancy: randScore(),
              ctxPrecision: randScore(),
              ctxRecall: randScore(),
            },
          };
        }
      }

      // ê°„ë‹¨ ìœ ì‚¬ë„(ë°ëª¨) â€” ì‹¤ì œë¡œëŠ” ë°±ì—”ë“œì—ì„œ ë¬¸ì¥ ì„ë² ë”© ì½”ì‚¬ì¸ ìœ ì‚¬ë„ ì¶”ì²œ
      function naiveSimilarity(a, b) {
        if (!a || !b) return 0;
        const la = a.length,
          lb = b.length;
        const min = Math.min(la, lb),
          max = Math.max(la, lb);
        return Math.round((min / max) * 100);
      }

      // íŒì •(ë°ëª¨): RAGAS 4ê°œ ì§€í‘œ + ìœ ì‚¬ë„*ê°€ì¤‘ì¹˜ + ë ˆì´í„´ì‹œ ì—­ê°€ì¤‘ì¹˜
      function judge(w) {
        if (state.isSingleMode) return "A"; // ì‹±ê¸€ ëª¨ë“œì—ì„œëŠ” íŒì • ë¶ˆí•„ìš”
        
        const sA = w.scores.A;
        const sB = w.scores.B;
        const a =
          sA.faithfulness +
          sA.relevancy +
          sA.ctxPrecision +
          sA.ctxRecall +
          (w.sim / 100) * 0.5 -
          (w.latA / 1000) * 0.1;
        const b =
          sB.faithfulness +
          sB.relevancy +
          sB.ctxPrecision +
          sB.ctxRecall +
          (w.sim / 100) * 0.5 -
          (w.latB / 1000) * 0.1;
        if (Math.abs(a - b) < 0.05) return "=";
        return a > b ? "A" : "B";
      }

      // í™”ë©´ ì—…ë°ì´íŠ¸
      function renderLatest(latest) {
        // ì¹´ë“œ
        $("#labA").textContent = latest.promptA.name || "Prompt A";
        $("#verA").textContent = latest.promptA.name || "-";
        $("#latA").textContent = latest.latA + " ms";
        $("#tokA").textContent = latest.tokA;
        $("#ansA").textContent = latest.ansA;

        if (!state.isSingleMode) {
          $("#labB").textContent = latest.promptB.name || "Prompt B";
          $("#verB").textContent = latest.promptB.name || "-";
          $("#latB").textContent = latest.latB + " ms";
          $("#tokB").textContent = latest.tokB;
          $("#ansB").textContent = latest.ansB;

          // ìœ ì‚¬ë„ ë°”
          $("#simBar").style.width = latest.sim + "%";
          $("#simScore").textContent = `Text Similarity: ${latest.sim}%`;
        }

        // ë©”íŠ¸ë¦­ í‘œ
        const S = latest.scores;
        const set = (id, v) =>
          ($(id).textContent = typeof v === "number" ? v.toFixed(2) : v);
        set("#faA", S.A.faithfulness);
        set("#arA", S.A.relevancy);
        set("#cpA", S.A.ctxPrecision);
        set("#crA", S.A.ctxRecall);
        set("#laA", latest.latA);
        set("#toA", latest.tokA);

        if (!state.isSingleMode) {
          set("#faB", S.B.faithfulness);
          set("#arB", S.B.relevancy);
          set("#cpB", S.B.ctxPrecision);
          set("#crB", S.B.ctxRecall);
          set("#laB", latest.latB);
          set("#toB", latest.tokB);

          // ìš°ì„¸ í‘œì‹œ
          const winCell = (a, b) => (a === b ? "=" : a > b ? "A" : "B");
          $("#faW").innerHTML = winPill(
            winCell(S.A.faithfulness, S.B.faithfulness)
          );
          $("#arW").innerHTML = winPill(winCell(S.A.relevancy, S.B.relevancy));
          $("#cpW").innerHTML = winPill(
            winCell(S.A.ctxPrecision, S.B.ctxPrecision)
          );
          $("#crW").innerHTML = winPill(winCell(S.A.ctxRecall, S.B.ctxRecall));
          $("#laW").innerHTML = winPill(winCell(-latest.latA, -latest.latB)); // ë‚®ì„ìˆ˜ë¡ ì¢‹ìŒ
          $("#toW").innerHTML = winPill(winCell(-latest.tokA, -latest.tokB)); // ë‚®ì„ìˆ˜ë¡ ì¢‹ìŒ

          const verdict = judge(latest);
          $("#jA").textContent =
            verdict === "A" ? "WIN" : verdict === "=" ? "TIE" : "";
          $("#jB").textContent =
            verdict === "B" ? "WIN" : verdict === "=" ? "TIE" : "";
          $("#jW").innerHTML = winPill(verdict);
        } else {
          // ì‹±ê¸€ ëª¨ë“œì—ì„œëŠ” ìš°ì„¸ í‘œì‹œ ì—†ìŒ
          ["#faW", "#arW", "#cpW", "#crW", "#laW", "#toW", "#jA", "#jB", "#jW"].forEach(
            (id) => ($(id).textContent = "-")
          );
        }

        // í•˜ë‹¨ ë¡œê·¸ í…Œì´ë¸” ì¶”ê°€
        const tbody = $("#runTable tbody");
        const row = document.createElement("tr");
        
        if (state.isSingleMode) {
          row.innerHTML = `
            <td>${state.runs.length}</td>
            <td>${escapeHtml(latest.query).slice(0, 120)}</td>
            <td>${escapeHtml(latest.promptA.name)}</td>
            <td class="b-column">-</td>
            <td class="metric">${S.A.faithfulness.toFixed(2)}</td>
            <td class="metric">${S.A.relevancy.toFixed(2)}</td>
            <td class="metric">${S.A.ctxPrecision.toFixed(2)}</td>
            <td class="metric">${S.A.ctxRecall.toFixed(2)}</td>
            <td class="b-column">-</td>
            <td class="b-column">-</td>
            <td class="metric">${latest.latA}</td>
            <td class="b-column">-</td>
            <td class="metric">${latest.tokA}</td>
            <td class="b-column">-</td>
          `;
        } else {
          const verdict = judge(latest);
          row.innerHTML = `
            <td>${state.runs.length}</td>
            <td>${escapeHtml(latest.query).slice(0, 120)}</td>
            <td>${escapeHtml(latest.promptA.name)}</td>
            <td class="b-column">${escapeHtml(latest.promptB.name)}</td>
            <td class="metric">${S.A.faithfulness.toFixed(
              2
            )} / ${S.B.faithfulness.toFixed(2)}</td>
            <td class="metric">${S.A.relevancy.toFixed(2)} / ${S.B.relevancy.toFixed(
              2
            )}</td>
            <td class="metric">${S.A.ctxPrecision.toFixed(
              2
            )} / ${S.B.ctxPrecision.toFixed(2)}</td>
            <td class="metric">${S.A.ctxRecall.toFixed(2)} / ${S.B.ctxRecall.toFixed(
              2
            )}</td>
            <td class="b-column metric">${latest.sim}%</td>
            <td class="b-column">${winPill(verdict)}</td>
            <td class="metric">${latest.latA}</td>
            <td class="b-column metric">${latest.latB}</td>
            <td class="metric">${latest.tokA}</td>
            <td class="b-column metric">${latest.tokB}</td>
          `;
        }
        tbody.prepend(row);

        // ìš”ì•½
        renderSummary();
        $("#runCount").textContent = "runs: " + state.runs.length;
      }

      function renderSummary() {
        if (state.runs.length === 0) {
          $("#summary").textContent = "";
          return;
        }
        const avg = (arr) => arr.reduce((a, b) => a + b, 0) / arr.length;
        const faA = avg(state.runs.map((r) => r.scores.A.faithfulness));
        const arA = avg(state.runs.map((r) => r.scores.A.relevancy));
        const cpA = avg(state.runs.map((r) => r.scores.A.ctxPrecision));
        const crA = avg(state.runs.map((r) => r.scores.A.ctxRecall));
        const latA = avg(state.runs.map((r) => r.latA));
        const tokA = avg(state.runs.map((r) => r.tokA));

        let summaryContent = `
        <div class="card">
          <strong>ì§‘ê³„ ìš”ì•½</strong>
          <div class="kv" style="margin-top:8px">
            <div>í‰ê·  Faithfulness</div><div>${faA.toFixed(3)}</div>
            <div>í‰ê·  Relevancy</div><div>${arA.toFixed(3)}</div>
            <div>í‰ê·  Ctx Precision</div><div>${cpA.toFixed(3)}</div>
            <div>í‰ê·  Ctx Recall</div><div>${crA.toFixed(3)}</div>
            <div>í‰ê·  Latency(ms)</div><div>${latA.toFixed(0)}</div>
            <div>í‰ê·  Tokens</div><div>${tokA.toFixed(0)}</div>`;

        if (!state.isSingleMode) {
          const faB = avg(state.runs.map((r) => r.scores.B.faithfulness));
          const arB = avg(state.runs.map((r) => r.scores.B.relevancy));
          const cpB = avg(state.runs.map((r) => r.scores.B.ctxPrecision));
          const crB = avg(state.runs.map((r) => r.scores.B.ctxRecall));
          const sim = avg(state.runs.map((r) => r.sim));
          const latB = avg(state.runs.map((r) => r.latB));
          const tokB = avg(state.runs.map((r) => r.tokB));
          const wins = state.runs.map(judge);
          const aW = wins.filter((w) => w === "A").length;
          const bW = wins.filter((w) => w === "B").length;
          const ties = wins.filter((w) => w === "=").length;

          summaryContent = `
          <div class="card">
            <strong>ì§‘ê³„ ìš”ì•½</strong>
            <div class="kv" style="margin-top:8px">
              <div>í‰ê·  Faithfulness</div><div>${faA.toFixed(3)} / ${faB.toFixed(3)}</div>
              <div>í‰ê·  Relevancy</div><div>${arA.toFixed(3)} / ${arB.toFixed(3)}</div>
              <div>í‰ê·  Ctx Precision</div><div>${cpA.toFixed(3)} / ${cpB.toFixed(3)}</div>
              <div>í‰ê·  Ctx Recall</div><div>${crA.toFixed(3)} / ${crB.toFixed(3)}</div>
              <div>í‰ê·  ìœ ì‚¬ë„</div><div>${sim.toFixed(1)}%</div>
              <div>í‰ê·  Latency(ms)</div><div>${latA.toFixed(0)} / ${latB.toFixed(0)}</div>
              <div>í‰ê·  Tokens</div><div>${tokA.toFixed(0)} / ${tokB.toFixed(0)}</div>
              <div>ìŠ¹ë¶€</div><div>A:${aW} Â· B:${bW} Â· Tie:${ties}</div>
            </div>
          </div>`;
        }

        summaryContent += `
          </div>
        </div>`;

        $("#summary").innerHTML = summaryContent;
      }

      // CSV ë‚´ë³´ë‚´ê¸°
      function exportCSV() {
        if (state.runs.length === 0) {
          alert("ë‚´ë³´ë‚¼ ì‹¤í–‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.");
          return;
        }

        let header, rows;
        
        if (state.isSingleMode) {
          header = [
            "index",
            "query",
            "promptA",
            "faithA",
            "relA",
            "ctxPrecA",
            "ctxRecA",
            "latA_ms",
            "tokA",
          ];
          rows = [header.join(",")];
          state.runs.forEach((r, i) => {
            rows.push(
              [
                i + 1,
                csvSafe(r.query),
                csvSafe(r.promptA.name),
                r.scores.A.faithfulness,
                r.scores.A.relevancy,
                r.scores.A.ctxPrecision,
                r.scores.A.ctxRecall,
                r.latA,
                r.tokA,
              ].join(",")
            );
          });
        } else {
          header = [
            "index",
            "query",
            "promptA",
            "promptB",
            "faithA",
            "faithB",
            "relA",
            "relB",
            "ctxPrecA",
            "ctxPrecB",
            "ctxRecA",
            "ctxRecB",
            "similarity",
            "winner",
            "latA_ms",
            "latB_ms",
            "tokA",
            "tokB",
          ];
          rows = [header.join(",")];
          state.runs.forEach((r, i) => {
            rows.push(
              [
                i + 1,
                csvSafe(r.query),
                csvSafe(r.promptA.name),
                csvSafe(r.promptB.name),
                r.scores.A.faithfulness,
                r.scores.B.faithfulness,
                r.scores.A.relevancy,
                r.scores.B.relevancy,
                r.scores.A.ctxPrecision,
                r.scores.B.ctxPrecision,
                r.scores.A.ctxRecall,
                r.scores.B.ctxRecall,
                r.sim,
                judge(r),
                r.latA,
                r.latB,
                r.tokA,
                r.tokB,
              ].join(",")
            );
          });
        }

        const blob = new Blob([rows.join("\n")], {
          type: "text/csv;charset=utf-8",
        });
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        const modePrefix = state.isSingleMode ? "single" : "ab";
        a.download = `prompt_${modePrefix}_results_${new Date()
          .toISOString()
          .slice(0, 19)
          .replace(/[:T]/g, "-")}.csv`;
        document.body.appendChild(a);
        a.click();
        a.remove();
      }

      // í—¤ë” ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
      function setupHeaderEventListeners() {
        // ê²°ê³¼ë³´ê¸° ë²„íŠ¼ - ëª¨ë“œì— ë”°ë¼ ì ì ˆí•œ í˜ì´ì§€ë¡œ ì´ë™
        const btnResultView = document.getElementById("btnResultView");
        if (btnResultView) {
          btnResultView.addEventListener("click", () => {
            console.log("ê²°ê³¼ë³´ê¸° ë²„íŠ¼ í´ë¦­, í˜„ì¬ ëª¨ë“œ:", state.isSingleMode ? "Single" : "A/B");
            if (state.isSingleMode) {
              // Single Modeì¼ ë•Œ single_result_view.htmlë¡œ ì´ë™
              location.href = 'single_result_view.html';
            } else {
              // A/B Modeì¼ ë•Œ result_view.htmlë¡œ ì´ë™
              location.href = 'result_view.html';
            }
          });
        }

        // ë¡œê·¸ë³´ê¸° ë²„íŠ¼ - ëª¨ë“œì— ë”°ë¼ ì ì ˆí•œ í˜ì´ì§€ë¡œ ì´ë™
        const btnLogView = document.getElementById("btnLogView");
        if (btnLogView) {
          btnLogView.addEventListener("click", () => {
            console.log("ë¡œê·¸ë³´ê¸° ë²„íŠ¼ í´ë¦­, í˜„ì¬ ëª¨ë“œ:", state.isSingleMode ? "Single" : "A/B");
            if (state.isSingleMode) {
              // Single Modeì¼ ë•Œ single_log_view.htmlë¡œ ì´ë™ (ì‹±ê¸€ ë¡œê·¸ë·°)
              location.href = 'single_log_view.html';
            } else {
              // A/B Modeì¼ ë•Œ log_view_css.htmlë¡œ ì´ë™ (A/B ë¡œê·¸ë·°)
              location.href = 'log_view_css.html';
            }
          });
        }

        // CSV ë‚´ë³´ë‚´ê¸° ë²„íŠ¼
        const btnExport = document.getElementById("btnExport");
        if (btnExport) {
          btnExport.addEventListener("click", exportCSV);
        }
      }

      // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
      function setupEventListeners() {
        $("#btnRun").addEventListener("click", async () => {
          const promptA = {
            name: $("#promptA_name").value.trim() || "A",
            tpl: $("#promptA_tpl").value.trim(),
          };
          
          let promptB = null;
          if (!state.isSingleMode) {
            promptB = {
              name: $("#promptB_name").value.trim() || "B",
              tpl: $("#promptB_tpl").value.trim(),
            };
          }
          
          const query = $("#userQuery").value.trim();
          if (!query) {
            alert("ì‚¬ìš©ì ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”.");
            return;
          }

          // LLM í˜¸ì¶œ (ì‹¤ì „ì—ì„œëŠ” ë°±ì—”ë“œ í˜¸ì¶œë¡œ êµì²´)
          const resA = await callLLM(
            $("#modelName").value || "internal-llm",
            promptA.tpl,
            query
          );
          
          let resB = null;
          if (!state.isSingleMode) {
            resB = await callLLM(
              $("#modelName").value || "internal-llm",
              promptB.tpl,
              query
            );
          }

          // RAGASë¥˜ ì ìˆ˜ ê³„ì‚° (ì‹¤ì „ì—ì„œëŠ” ì„œë²„ì—ì„œ ê³„ì‚°)
          const scores = await evalRAGAS(resA.text, resB ? resB.text : null);
          const sim = !state.isSingleMode ? naiveSimilarity(resA.text, resB.text) : 0;

          const run = {
            time: Date.now(),
            query,
            promptA,
            promptB: promptB || { name: "", tpl: "" },
            ansA: resA.text,
            ansB: resB ? resB.text : "",
            latA: resA.latency,
            latB: resB ? resB.latency : 0,
            tokA: resA.tokens,
            tokB: resB ? resB.tokens : 0,
            sim,
            scores,
          };
          state.runs.push(run);
          renderLatest(run);
        });

        $("#btnClear").addEventListener("click", () => {
          state.runs = [];
          $("#runTable tbody").innerHTML = "";
          $("#summary").textContent = "";
          $("#runCount").textContent = "runs: 0";
          // ìƒë‹¨ ì¹´ë“œ ì´ˆê¸°í™”
          ["latA", "latB", "tokA", "tokB", "ansA", "ansB", "simScore"].forEach(
            (id) => ($("#" + id).textContent = "-")
          );
          $("#simBar").style.width = "0%";
          [
            "faA",
            "faB",
            "arA",
            "arB",
            "cpA",
            "cpB",
            "crA",
            "crB",
            "laA",
            "laB",
            "toA",
            "toB",
            "faW",
            "arW",
            "cpW",
            "crW",
            "laW",
            "toW",
            "jA",
            "jB",
            "jW",
          ].forEach((id) => ($("#" + id).textContent = "-"));
        });

        // CSV ë‚´ë³´ë‚´ê¸°ì™€ ê²°ê³¼ë³´ê¸°ëŠ” í—¤ë” ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆì—ì„œ ì²˜ë¦¬
      }

      // ë³´ì¡° í•¨ìˆ˜ë“¤
      function escapeHtml(s) {
        if (!s) return "";
        return s.replace(
          /[&<>"']/g,
          (m) =>
            ({
              "&": "&amp;",
              "<": "&lt;",
              ">": "&gt;",
              '"': "&quot;",
              "'": "&#39;",
            }[m])
        );
      }
      
      function csvSafe(s) {
        if (s === undefined || s === null) return "";
        s = String(s);
        if (/[",\n]/.test(s)) return `"${s.replace(/"/g, '""')}"`;
        return s;
      }

      // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
      document.addEventListener("DOMContentLoaded", () => {
        console.log("í˜ì´ì§€ ë¡œë“œë¨, ì´ˆê¸°í™” ì‹œì‘");
        initializeApp();
        setupEventListeners();
      });

      // í˜ì´ì§€ë¥¼ ë– ë‚  ë•Œ state ì €ì¥
      window.addEventListener("beforeunload", () => {
        localStorage.setItem("ab_runs", JSON.stringify(state.runs));
        localStorage.setItem("ab_mode", JSON.stringify(state.isSingleMode));
      });

      // í˜ì´ì§€ ë¡œë“œ ì‹œ ì €ì¥ëœ state ë³µì›
      window.addEventListener("load", () => {
        const savedRuns = localStorage.getItem("ab_runs");
        const savedMode = localStorage.getItem("ab_mode");
        
        if (savedRuns) {
          try {
            state.runs = JSON.parse(savedRuns);
            // ì €ì¥ëœ ì‹¤í–‰ ê²°ê³¼ë“¤ì„ í…Œì´ë¸”ì— ë³µì›
            state.runs.forEach((run, index) => {
              const tbody = $("#runTable tbody");
              const row = document.createElement("tr");
              
              if (state.isSingleMode) {
                row.innerHTML = `
                  <td>${index + 1}</td>
                  <td>${escapeHtml(run.query).slice(0, 120)}</td>
                  <td>${escapeHtml(run.promptA.name)}</td>
                  <td class="b-column">-</td>
                  <td class="metric">${run.scores.A.faithfulness.toFixed(2)}</td>
                  <td class="metric">${run.scores.A.relevancy.toFixed(2)}</td>
                  <td class="metric">${run.scores.A.ctxPrecision.toFixed(2)}</td>
                  <td class="metric">${run.scores.A.ctxRecall.toFixed(2)}</td>
                  <td class="b-column">-</td>
                  <td class="b-column">-</td>
                  <td class="metric">${run.latA}</td>
                  <td class="b-column">-</td>
                  <td class="metric">${run.tokA}</td>
                  <td class="b-column">-</td>
                `;
              } else {
                const verdict = judge(run);
                row.innerHTML = `
                  <td>${index + 1}</td>
                  <td>${escapeHtml(run.query).slice(0, 120)}</td>
                  <td>${escapeHtml(run.promptA.name)}</td>
                  <td class="b-column">${escapeHtml(run.promptB.name)}</td>
                  <td class="metric">${run.scores.A.faithfulness.toFixed(2)} / ${run.scores.B.faithfulness.toFixed(2)}</td>
                  <td class="metric">${run.scores.A.relevancy.toFixed(2)} / ${run.scores.B.relevancy.toFixed(2)}</td>
                  <td class="metric">${run.scores.A.ctxPrecision.toFixed(2)} / ${run.scores.B.ctxPrecision.toFixed(2)}</td>
                  <td class="metric">${run.scores.A.ctxRecall.toFixed(2)} / ${run.scores.B.ctxRecall.toFixed(2)}</td>
                  <td class="b-column metric">${run.sim}%</td>
                  <td class="b-column">${winPill(verdict)}</td>
                  <td class="metric">${run.latA}</td>
                  <td class="b-column metric">${run.latB}</td>
                  <td class="metric">${run.tokA}</td>
                  <td class="b-column metric">${run.tokB}</td>
                `;
              }
              tbody.appendChild(row);
            });
            
            renderSummary();
            $("#runCount").textContent = "runs: " + state.runs.length;
          } catch (e) {
            console.error("ì €ì¥ëœ ì‹¤í–‰ ê²°ê³¼ ë³µì› ì‹¤íŒ¨:", e);
          }
        }
        
        if (savedMode) {
          try {
            const isSingleMode = JSON.parse(savedMode);
            if (isSingleMode !== state.isSingleMode) {
              toggleMode(); // ì €ì¥ëœ ëª¨ë“œë¡œ ì „í™˜
            }
          } catch (e) {
            console.error("ì €ì¥ëœ ëª¨ë“œ ë³µì› ì‹¤íŒ¨:", e);
          }
        }
      });
    </script>
  </body>
</html>